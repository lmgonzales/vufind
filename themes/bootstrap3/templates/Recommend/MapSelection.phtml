<?php if ($this->recommend->getSearchResultCoordinates()) :?>
<?php
  $geoPlatform = $this->recommend->getGeoPlatform();
  //Include files based on geoPlatform configuration
  $this->headScript()->appendFile('vendor/leaflet/leaflet.js');
  $this->headScript()->appendFile('vendor/leaflet/leaflet.draw.js');
  $this->headScript()->appendFile('vendor/leaflet/leaflet.markercluster.js');
  $this->headScript()->appendFile('map_selection_leaflet.js');
  $this->headLink()->appendStylesheet('vendor/leaflet/leaflet.css');
  $this->headLink()->appendStylesheet('vendor/leaflet/leaflet.draw.css');
  $this->headLink()->appendStylesheet('vendor/leaflet/MarkerCluster.css');
  $this->headLink()->appendStylesheet('vendor/leaflet/MarkerCluster.Default.css');
  $this->headLink()->appendStylesheet('geofeatures.css');

  // Call methods based on geoPlatform configuration
  $basemap = $this->recommend->getBasemap();
  $geoField = $this->recommend->getGeoField();
  $height = $this->recommend->getHeight();
  $showSelection = true;
  $baseUrl = $this->url('home');
  $urlpath = $this->url('search-results');
  $searchParams = $this->recommend->getSearchParams();
  $coordinates = $this->recommend->getSelectedCoordinates();

  if ($coordinates == null) {
    $coordinates = $this->recommend->getDefaultCoordinates();
    $showSelection = false;
  }
  $helpTopic = 'geosearch_leaflet';
  $resultsCoords = $this->recommend->getMapResultCoordinates();
  $params = [json_encode($geoField), json_encode($coordinates),
    json_encode($urlpath), json_encode($baseUrl),
    json_encode($searchParams), json_encode($showSelection),
    json_encode($resultsCoords), json_encode($basemap)];

  $jsParams = implode(', ', $params);
  $jsLoad = "loadMapSelection(" . $jsParams . ");";
  $addSearchOption = <<<EOF
    $('.search-query-options>.advanced').after('&nbsp;&nbsp;<a href="#" class="advanced" onclick=\\'{$jsLoad} $(this).remove(); return false;\\'>{$this->transEsc('Geographic Search')}</a>');
EOF;
?>
<div class="authorbox">
  <div id="geo_search" style="display: none;">
    <button id="draw_box"><?=$this->transEsc('Draw Search Box')?></button>
    <span class="geo_maphelp">&nbsp;<a href="<?=$this->url('help-home')?>?topic=geosearch" data-lightbox class="help-link"><?=$this->transEsc('Need Help?')?></a></span>
    <div id="geo_search_map" style="height: <?=$height?>px;"></div>
  </div>
  <?php if ($showSelection) :?>
    <?=$this->inlineScript(\Zend\View\Helper\HeadScript::SCRIPT, $jsLoad, 'SET');?>
  <?php else: ?>
    <?=$this->inlineScript(\Zend\View\Helper\HeadScript::SCRIPT, $addSearchOption, 'SET');?>
  <?php endif; ?>
</div>
<?php endif; ?>
